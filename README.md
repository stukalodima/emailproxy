# Email OAuth 2.0 Proxy<a id="email-oauth-20-proxy"></a>
Додайте підтримку OAuth 2.0 до клієнтських програм IMAP/POP/SMTP, сценаріїв або будь-яких інших варіантів використання електронної пошти, які не підтримують цей метод автентифікації.

### Приклади використання<a id="example-use-cases"></a>
- Вам потрібно використовувати обліковий запис електронної пошти Office 365, але ваш клієнт не підтримує сучасні методи авторизації.
Поштовий клієнт, що ви використовуєте, не підтримує OAuth 2.0, який став обов’язковим [in January 2023](https://techcommunity.microsoft.com/t5/exchange-team-blog/basic-authentication-deprecation-in-exchange-online-september/ba-p/3609437) ([September 2024 for free Hotmail/Outlook accounts](https://support.microsoft.com/en-us/office/modern-authentication-methods-now-needed-to-continue-syncing-outlook-email-in-non-microsoft-email-apps-c5d65390-9676-4763-b41f-d7986499a90d); [September 2025 for O365 SMTP](https://techcommunity.microsoft.com/t5/exchange-team-blog/exchange-online-to-retire-basic-auth-for-client-submission-smtp/ba-p/4114750)).

У цьому випадку цей проксі може допомогти.
Щоб розпочати, дотримуйтеся наведених тут інструкцій.


## Почати використання<a id="getting-started"></a>
Почніть із завантаження проксі:

<b>Клонуйте або <a href="https://github.com/stukalodima/emailproxy/archive/refs/heads/master.zip">завантажте</a></b>, потім виконайте: <code>python -m pip install -r requirements-core.txt -r requirements-gui.txt</code> для встановлення залежностей, та <code>python emailproxy.py</code> для запуску.

P.S. На сервері мє бути встановлений <a href="https://www.python.org/downloads/"> python3 </a> <br>
Та <a href="https://pip.pypa.io/en/stable/installation/#">система керування пакунками</a>, яка використовується для встановлення та управління програмними пакетами, які написані на Python

Далі, відредагуйте файл `emailproxy.config` щоб додати деталі конфігурації для кожного сервера електронної пошти та облікового запису, який ви хочете використовувати з проксі.
[Інструкції та приклади конфігурацій облікового запису](https://github.com/stukalodima/emailproxy/blob/master/emailproxy.config) надаються для Office 365, але вам потрібно буде вставити власні облікові дані клієнта (дивись [OAuth 2.0 облікові дані клієнта](#oauth-20-client-credentials) нижче).

Тепер ви можете запустити проксі-сервер: командою запуску, наведеною вище. Має з’явитися піктограма панелі меню/панелі завдань.
Додаткові параметри, див [необов'язкові аргументи та конфігурація](#optional-arguments-and-configuration) та [розширена конфігурація](#advanced-configuration).

Нарешті, відкрийте клієнт електронної пошти та налаштуйте дані його сервера відповідно до тих, які ви вказали у файлі конфігурації проксі. 
Правильний сервер для використання з обліковим записом визначається за номером порту, який ви вибрали у своєму клієнті. 
Наприклад, для використання прикладу деталей Office 365 це буде 127.0.0.1 на порту 1993 для IMAP, порту 1995 для POP і порту 1587 для SMTP. 
Проксі-сервер підтримує кілька облікових записів одночасно, і всі облікові записи, пов’язані з одним провайдером, можуть спільно використовувати той самий проксі-сервер. 
Локальне з’єднання у вашому поштовому клієнті має бути налаштовано як незашифроване, щоб проксі-сервер міг працювати, але з’єднання між проксі-сервером і сервером електронної пошти завжди безпечне (неявний SSL/TLS для IMAP і POP; неявний або явний (STARTTLS) SSL/TLS для SMTP).
Дивсь [зразок файлу конфігурації](https://github.com/stukalodima/emailproxy/blob/master/emailproxy.config) документація про додаткові функції, включаючи локальне шифрування, успадкування конфігурації облікового запису та підтримку роботи в контейнері.

Коли ваш клієнт електронної пошти вперше надсилає запит, ви маєте побачити сповіщення від проксі про авторизацію вашого облікового запису.
Клацніть піктограму на панелі меню проксі-сервера, виберіть ім’я свого облікового запису в підменю «Авторизувати обліковий запис», а потім увійдіть у спливаюче вікно браузера, яке з’явиться.
Після завершення процесу вікно закриється.
Дивись [необов'язкові аргументи та конфігурація](#optional-arguments-and-configuration) для підтримки завершення автентифікації, якщо проксі працює без графічного інтерфейсу користувача.

Після успішної автентифікації та авторизації ви повинні мати доступ IMAP/POP/SMTP до свого облікового запису як зазвичай.
Переконайтеся, що проксі-сервер постійно працює, щоб дозволити йому авторизувати фонову діяльність вашого клієнта електронної пошти.

Після того, як ваші облікові записи буде повністю налаштовано та авторизовано, подальша взаємодія з проксі-сервером не потрібна, якщо ваш обліковий запис не потребує повторної авторизації.
Він сповістить вас, якщо це буде потрібно.

### OAuth 2.0 облікові дані клієнта<a id="oauth-20-client-credentials"></a>
У рамках процесу налаштування проксі вам потрібно надати OAuth 2.0 `client_id` та `client_secret` щоб дозволити йому автентифікуватися на серверах електронної пошти від вашого імені.

Якщо у вас є наявний ідентифікатор клієнта та секрет для корпоративного додатку, ви можете використовувати їх безпосередньо в проксі.

Якщо у вас немає облікових даних наявного клієнта, вам потрібно буде зареєструвати свій власний.
Під час реєстрації переконайтеся, що ваш клієнт налаштовано на використання області OAuth, яка надасть йому дозвіл на доступ до IMAP/POP/SMTP
Також рекомендується використовувати область, яка надаватиме доступ «офлайн». (спосіб [оновлення маркера автентифікації OAuth 2.0](https://oauth.net/2/refresh-tokens/) без втручання користувача).
[Зразок файлу конфігурації](https://github.com/stukalodima/emailproxy/blob/master/emailproxy.config) містить приклади значень області для Office 365.

Office 365: реєстрація нового корпоративного додатку [Microsoft identity application](https://learn.microsoft.com/entra/identity-platform/quickstart-register-app)

## Необов'язкові аргументи та конфігурація<a id="optional-arguments-and-configuration"></a>
Під час запуску проксі є кілька додаткових аргументів, які можна встановити для налаштування його поведінки.

- `--no-gui` запустить проксі без піктограми, що дозволяє запускати його як службу.
Зауважте, що якщо ви також не вкажете один із наведених нижче параметрів авторизації, цей режим можна використовувати, лише якщо ви вже авторизували свої облікові записи через проксі-сервер у режимі GUI або імпортуєте попередньо авторизований файл конфігурації проксі-сервера з іншого місця.
Якщо не встановити `--external-auth` або `--local-server-auth`, облікові записи, які ще не були авторизовані (або з будь-якої причини потребують повторної авторизації), будуть пропущені під час автентифікації, і в журналі буде надруковано повідомлення про помилку.

- `--external-auth` налаштовує проксі-сервер для представлення URL-адреси авторизації облікового запису для відкриття у зовнішньому браузері та чекає, поки ви скопіюєте та вставите результат після авторизації.
У режимі GUI це може бути корисним у ситуаціях, коли власне вікно браузера проксі-сервера не має доступу до деяких необхідних атрибутів автентифікації у вашому типовому налаштуванні.
У режимі без графічного інтерфейсу ця опція дає змогу автентифікувати облікові записи повністю ззовні (навідміну `--local-server-auth`, який запускає локальний веб-сервер), хоча вам потрібно буде відстежувати вихідні дані проксі та/або реєструвати сповіщення про автентифікацію.

    Перейшовши за наданим посиланням і авторизувавши доступ до облікового запису, вставте кінцеву URL-адресу з адресного рядка веб-переглядача назад у спливаюче вікно проксі (режим графічного інтерфейсу) або термінал (режим без графічного інтерфейсу), щоб надати йому доступ для прозорого проксі-сервера вашого входу.
Ви повинні ігнорувати будь-яке повідомлення про помилку браузера, яке відображається (наприклад `unable to connect`); важливою частиною є сама URL-адреса.
Цей аргумент ідентичний увімкненню режиму зовнішньої авторизації з `Authorise account` підменю піктограми панелі меню проксі.

- `--local-server-auth` схожий на `--external-auth`, але замість цього вказує проксі-серверу тимчасово запустити внутрішній веб-сервер для отримання відповідей автентифікації.
Аргумент `--external-auth` у цьому режимі параметр ігнорується.
Щоб авторизувати свій обліковий запис, перейдіть за наданим посиланням, пройдіть автентифікацію та продовжуйте, доки вам не відкриється успішна веб-сторінка з проксі-сервера.
Будь ласка, зверніть увагу, що хоча посилання автентифікації фактично можна відвідати будь-де, щоб увійти в систему та авторизувати доступ, за замовчуванням кінцева ціль переспрямування (посилання, що починається з вашого облікового запису `redirect_uri` значення) необхідно отримати доступ із машини, на якій розміщено сам проксі, щоб локальний сервер міг отримати результат авторизації.

- `--config-file` дозволяє вказати розташування [файлу конфігурації](https://github.com/stukalodima/emailproxy/blob/master/emailproxy.config).
Якщо цей аргумент не надано, проксі шукатиме `emailproxy.config` у своєму робочому каталозі.
За замовчуванням проксі-сервер також зберігає кешовані маркери OAuth 2.0 у цей файл, тому він має бути доступним для запису.
Є аргумент `--cache-store`, якщо ви бажаєте зберігати конфігурацію та кешовані значення окремо.

- `--cache-store` використовується для визначення окремого місця для кешування авторизованих маркерів OAuth 2.0 і пов’язаних метаданих.
Значення цього аргументу може бути або повним шляхом до локального файлу (який має бути доступним для запису), або ідентифікатором для зовнішнього сховища, такого як диспетчер секретів (дивись [Розширена конфігурація](#advanced-configuration)).
Якщо цей аргумент не надано, облікові дані будуть кешовані в поточному файлі конфігурації.

- `--log-file` дозволяє вказати розташування файлу, в який будуть записуватися вихідні дані журналу (потрібен повний шлях).
Файли журналу обмежуються розміром 32 МБ і зберігаються 10 старіших файлів журналу.

- `--debug` вмикає режим налагодження, записуючи більш детальний вивід у журнал.
Цей аргумент ідентичний увімкненню режиму налагодження за допомогою піктограми панелі меню проксі.

### Розширена конфігурація<a id="advanced-configuration"></a>
[Зразок файлу конфігурації](https://github.com/stukalodima/emailproxy/blob/master/emailproxy.config) містить додаткову документацію щодо різноманітних додаткових функцій проксі-сервера, включно з локально зашифрованими з’єднаннями та розширеними потоками Office 365 OAuth 2.0.

За замовчуванням проксі-сервер кешує автентифіковані маркери OAuth 2.0 і пов’язані метадані у власний файл конфігурації, але в якості альтернативи його можна налаштувати для використання окремого локального файлу або служби диспетчера секретів для цієї мети.
Наразі віддалене зберігання маркерів працює у тестовому режимі(існують деякі обмеження azure key-vault). Тому поки не рекомендується використовувати служби диспетчера секретів.

### Автоматичний запуск проксі<a id="starting-the-proxy-automatically"></a>
Щоб проксі-сервер автентифікував фонові запити від вашого клієнта електронної пошти, він має постійно працювати.
Найпростіший спосіб зробити це — запустити сценарій автоматично.
У режимі графічного інтерфейсу для цього: клацніть його піктограму на панелі меню та виберіть `Start at login`, після цього додаток зупинить екземпляр терміналу та перезапустить сценарій, налаштувавши його на виконання кожного разу, коли ви входите в систему.


## License<a id="license"></a>
[Apache 2.0](https://github.com/stukalodima/emailproxy/blob/master/LICENSE)
